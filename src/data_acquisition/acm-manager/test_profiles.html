<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACM Manager - Profile Management Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    
    .test-section h2 {
      margin-top: 0;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    button {
      background-color: #2196f3;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    
    button:hover {
      background-color: #1976d2;
    }
    
    button.secondary {
      background-color: #e0e0e0;
      color: #333;
    }
    
    button.secondary:hover {
      background-color: #d5d5d5;
    }
    
    .result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    
    .result.success {
      background-color: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    
    .result.error {
      background-color: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
    }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .status.authenticated {
      background-color: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    
    .status.not-authenticated {
      background-color: #fff3e0;
      border: 1px solid #ff9800;
      color: #e65100;
    }
    
    .profiles-list {
      margin-top: 15px;
    }
    
    .profile-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background-color: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .profile-item.selected {
      background-color: #e3f2fd;
      border-color: #2196f3;
    }
    
    .profile-item-info {
      flex: 1;
    }
    
    .profile-item-name {
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .profile-item-date {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>ACM Manager - Profile Management Test</h1>
  
  <div id="authStatus" class="status not-authenticated">
    Checking authentication status...
  </div>
  
  <div class="test-section">
    <h2>Authentication Status</h2>
    <button id="checkAuthBtn">Check Authentication</button>
    <button id="getUserBtn" class="secondary">Get Current User</button>
    <div id="authResult" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>Profile Management</h2>
    <div class="form-group">
      <label for="newProfileName">New Profile Name:</label>
      <input type="text" id="newProfileName" placeholder="Enter profile name">
    </div>
    <button id="createProfileBtn">Create Profile</button>
    <button id="getProfilesBtn" class="secondary">Get All Profiles</button>
    <button id="getSelectedProfileBtn" class="secondary">Get Selected Profile</button>
    <div id="profileResult" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>Profile Selection</h2>
    <div id="profilesList" class="profiles-list">
      <div class="loading">No profiles loaded. Click "Get All Profiles" to load them.</div>
    </div>
  </div>
  
  <div class="test-section">
    <h2>Data Packet Test</h2>
    <button id="testDataPacketBtn">Test Data Packet with Selected Profile</button>
    <div id="dataPacketResult" class="result"></div>
  </div>
  
  <script src="js/auth.js"></script>
  <script>
    let userProfiles = [];
    let selectedProfile = null;
    
    // Test functions
    async function checkAuthentication() {
      try {
        const isAuth = await authService.isAuthenticated();
        const user = await authService.getCurrentUser();
        
        const statusEl = document.getElementById('authStatus');
        const resultEl = document.getElementById('authResult');
        
        if (isAuth && user) {
          statusEl.className = 'status authenticated';
          statusEl.textContent = `Authenticated as ${user.email} (${user.first_name} ${user.last_name})`;
          
          resultEl.className = 'result success';
          resultEl.textContent = JSON.stringify({ authenticated: true, user }, null, 2);
        } else {
          statusEl.className = 'status not-authenticated';
          statusEl.textContent = 'Not authenticated';
          
          resultEl.className = 'result error';
          resultEl.textContent = 'Not authenticated';
        }
      } catch (error) {
        document.getElementById('authResult').className = 'result error';
        document.getElementById('authResult').textContent = `Error: ${error.message}`;
      }
    }
    
    async function createProfile() {
      const name = document.getElementById('newProfileName').value.trim();
      
      if (!name) {
        document.getElementById('profileResult').className = 'result error';
        document.getElementById('profileResult').textContent = 'Please enter a profile name';
        return;
      }
      
      try {
        const result = await authService.createProfile(name);
        
        const resultEl = document.getElementById('profileResult');
        if (result.success) {
          resultEl.className = 'result success';
          resultEl.textContent = `Profile created successfully!\n${JSON.stringify(result.profile, null, 2)}`;
          
          // Clear input and reload profiles
          document.getElementById('newProfileName').value = '';
          await getProfiles();
        } else {
          resultEl.className = 'result error';
          resultEl.textContent = `Failed to create profile: ${result.error}`;
        }
      } catch (error) {
        document.getElementById('profileResult').className = 'result error';
        document.getElementById('profileResult').textContent = `Error: ${error.message}`;
      }
    }
    
    async function getProfiles() {
      try {
        const result = await authService.getProfiles();
        
        const resultEl = document.getElementById('profileResult');
        if (result.success) {
          userProfiles = result.profiles;
          resultEl.className = 'result success';
          resultEl.textContent = `Found ${result.profiles.length} profiles:\n${JSON.stringify(result.profiles, null, 2)}`;
          
          // Update profiles list
          updateProfilesList();
        } else {
          resultEl.className = 'result error';
          resultEl.textContent = `Failed to get profiles: ${result.error}`;
        }
      } catch (error) {
        document.getElementById('profileResult').className = 'result error';
        document.getElementById('profileResult').textContent = `Error: ${error.message}`;
      }
    }
    
    async function getSelectedProfile() {
      try {
        selectedProfile = await authService.getSelectedProfile();
        const profileId = await authService.getSelectedProfileId();
        
        const resultEl = document.getElementById('profileResult');
        if (selectedProfile) {
          resultEl.className = 'result success';
          resultEl.textContent = `Selected Profile:\n${JSON.stringify(selectedProfile, null, 2)}\n\nProfile ID: ${profileId}`;
        } else {
          resultEl.className = 'result error';
          resultEl.textContent = 'No profile selected';
        }
      } catch (error) {
        document.getElementById('profileResult').className = 'result error';
        document.getElementById('profileResult').textContent = `Error: ${error.message}`;
      }
    }
    
    function updateProfilesList() {
      const listEl = document.getElementById('profilesList');
      
      if (userProfiles.length === 0) {
        listEl.innerHTML = '<div class="loading">No profiles found</div>';
        return;
      }
      
      const profilesHtml = userProfiles.map(profile => {
        const isSelected = selectedProfile && selectedProfile.id === profile.id;
        const createDate = new Date(profile.create_timestamp).toLocaleDateString();
        
        return `
          <div class="profile-item ${isSelected ? 'selected' : ''}">
            <div class="profile-item-info">
              <div class="profile-item-name">${profile.name}</div>
              <div class="profile-item-date">Created: ${createDate}</div>
            </div>
            <div class="profile-item-actions">
              ${!isSelected ? `<button onclick="selectProfile('${profile.id}')" class="secondary">Select</button>` : '<span style="color: #2196f3;">Selected</span>'}
            </div>
          </div>
        `;
      }).join('');
      
      listEl.innerHTML = profilesHtml;
    }
    
    async function selectProfile(profileId) {
      try {
        const profile = userProfiles.find(p => p.id === profileId);
        if (profile) {
          await authService.setSelectedProfile(profile);
          selectedProfile = profile;
          
          const resultEl = document.getElementById('profileResult');
          resultEl.className = 'result success';
          resultEl.textContent = `Profile selected: ${profile.name}`;
          
          updateProfilesList();
        }
      } catch (error) {
        document.getElementById('profileResult').className = 'result error';
        document.getElementById('profileResult').textContent = `Error selecting profile: ${error.message}`;
      }
    }
    
    async function testDataPacket() {
      try {
        const profileId = await authService.getSelectedProfileId();
        
        if (!profileId) {
          document.getElementById('dataPacketResult').className = 'result error';
          document.getElementById('dataPacketResult').textContent = 'No profile selected. Please select a profile first.';
          return;
        }
        
        // Simulate a data packet
        const testPacket = {
          id: 'test-packet-' + Date.now(),
          profile_id: profileId,
          tags: ['TEST', 'ACM-Manager-Plugin'],
          data: {
            sourceChatbot: 'TestChatbot',
            interactions: [
              { role: 'user', content: 'Hello, this is a test message' },
              { role: 'assistant', content: 'Hello! This is a test response' }
            ],
            conversationUrl: 'https://test.example.com/chat/123'
          }
        };
        
        document.getElementById('dataPacketResult').className = 'result success';
        document.getElementById('dataPacketResult').textContent = `Test data packet would be sent with profile ID: ${profileId}\n\n${JSON.stringify(testPacket, null, 2)}`;
      } catch (error) {
        document.getElementById('dataPacketResult').className = 'result error';
        document.getElementById('dataPacketResult').textContent = `Error: ${error.message}`;
      }
    }
    
    // Event listeners
    document.getElementById('checkAuthBtn').addEventListener('click', checkAuthentication);
    document.getElementById('getUserBtn').addEventListener('click', async () => {
      try {
        const user = await authService.getCurrentUser();
        const resultEl = document.getElementById('authResult');
        if (user) {
          resultEl.className = 'result success';
          resultEl.textContent = JSON.stringify(user, null, 2);
        } else {
          resultEl.className = 'result error';
          resultEl.textContent = 'No user data found';
        }
      } catch (error) {
        document.getElementById('authResult').className = 'result error';
        document.getElementById('authResult').textContent = `Error: ${error.message}`;
      }
    });
    document.getElementById('createProfileBtn').addEventListener('click', createProfile);
    document.getElementById('getProfilesBtn').addEventListener('click', getProfiles);
    document.getElementById('getSelectedProfileBtn').addEventListener('click', getSelectedProfile);
    document.getElementById('testDataPacketBtn').addEventListener('click', testDataPacket);
    
    // Check authentication status on page load
    checkAuthentication();
  </script>
</body>
</html> 