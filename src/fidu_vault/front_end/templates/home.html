{% extends "base.html" %}

{% block title %}FIDU Vault - Welcome{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="max-w-md w-full space-y-8 p-8">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">FIDU Vault</h1>
            <p class="text-gray-600">Your Personal Data Management System</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Welcome</h2>
                <p class="text-gray-600 mb-6">Sign in to your account or create a new one to get started.</p>
            </div>
            
            <!-- FIDU SDK Auth Widget -->
            <div id="fiduAuthContainer"></div>
            
            <script src="{{ identity_service_url }}/static/js/fidu-sdk.js"></script>
            <script>
            // Wait for SDK to load
            function waitForSDK() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5 seconds with 100ms intervals
                    
                    const checkSDK = () => {
                        attempts++;
                        if (typeof FIDUAuth !== 'undefined') {
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('FIDU SDK failed to load after 5 seconds'));
                        } else {
                            setTimeout(checkSDK, 100);
                        }
                    };
                    
                    checkSDK();
                });
            }

            // Initialize FIDU SDK
            async function initializeFIDU() {
                try {
                    // Wait for SDK to be available
                    await waitForSDK();
                    
                    // Initialize FIDU SDK
                    const fidu = new FIDUAuth({
                        fiduHost: '{{ identity_service_url }}',
                        debug: true
                    });

                    // Set up event handlers
                    fidu.on('onAuthSuccess', (user, token, portalUrl) => {
                        // Handle new authentication response format with refresh tokens
                        let accessToken = token;
                        let refreshToken = '';
                        let expiresIn = 86400;
                        
                        console.log('onAuthSuccess', token);

                        // Check if token is an object with the new format
                        if (typeof token === 'object' && token.access_token) {
                            accessToken = token.access_token;
                            refreshToken = token.refresh_token || '';
                            expiresIn = token.expires_in || 86400;
                        }
                        
                        // Store tokens in localStorage
                        localStorage.setItem('auth_token', accessToken);
                        localStorage.setItem('token_expires_in', expiresIn.toString());
                        
                        // Note: refresh_token is handled by the SDK as 'fiduRefreshToken'
                        // We don't need to duplicate it here
                        
                        // Set auth_token cookie for backend compatibility (expires in 1 hour)
                        document.cookie = `auth_token=${accessToken}; path=/; max-age=3600; samesite=lax`;
                        
                        // Store refresh token in a separate cookie for longer persistence
                        // Use the refresh token from the SDK response if available
                        if (refreshToken) {
                            document.cookie = `refresh_token=${refreshToken}; path=/; max-age=2592000; samesite=lax`; // 30 days
                        }
                        
                        // Redirect to dashboard
                        window.location.href = "/dashboard";
                    });

                    fidu.on('onAuthError', (error) => {
                        console.error('Auth error:', error);
                    });

                    // Check if user is already authenticated
                    const isAuthenticated = await fidu.init();
                    
                    if (!isAuthenticated) {
                        // Show login widget
                        fidu.showLoginWidget();
                    } else {
                        window.location.href = "/dashboard";
                    }
                    
                } catch (error) {
                    console.error('FIDU initialization error:', error);
                    
                    // Fallback: show manual login link
                    const container = document.getElementById('fiduAuthContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center p-4 border border-red-200 rounded bg-red-50">
                                <p class="text-red-700 mb-4">Unable to load login widget</p>
                                <a href="{{ identity_service_url }}/login" 
                                   target="_blank" 
                                   class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                    Open Login Page
                                </a>
                            </div>
                        `;
                    }
                }
            }

            // Clean up duplicate refresh token keys
            function cleanupDuplicateTokens() {
                // Remove the empty refresh_token since we're using fiduRefreshToken
                if (localStorage.getItem('refresh_token') === '') {
                    localStorage.removeItem('refresh_token');
                }
            }
            
            // Start initialization when page loads
            document.addEventListener('DOMContentLoaded', function() {
                cleanupDuplicateTokens();
                initializeFIDU();
            });

            // Also try to initialize immediately if DOM is already loaded
            if (document.readyState !== 'loading') {
                cleanupDuplicateTokens();
                initializeFIDU();
            }
            </script>
        </div>
        

    </div>
</div>
{% endblock %} 