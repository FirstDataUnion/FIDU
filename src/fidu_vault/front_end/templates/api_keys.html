{% extends "base.html" %}

{% block title %}FIDU Vault - API Keys{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    {% include 'nav.html' %}

    <!-- Main content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {% include 'nav_tabs.html' %}

        <!-- Page header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">API Keys</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-300">
                Use this page to add your own existing API keys to FIDU Vault, allowing connected apps to use them when communicating with AI model providers.
                <br>
                This is optional, and paying users do not need to provide their own API keys, but provides an option for free members to use FIDU services with their own existing API keys. 
                <br>
                Note that free members will only be able to interact with models that they provide the keys for. 
            </p>
        </div>

        <!-- Add new API key form -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Add New API Key</h3>
                <form id="api-key-form" hx-post="/api-keys/add" hx-target="#api-keys-list" hx-swap="outerHTML">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <label for="provider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Provider</label>
                            <select id="provider" name="provider" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">Select a provider</option>
                                <option value="google">Google/Gemini</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="groq">Groq</option>
                                <option value="cohere">Cohere</option>
                                <option value="huggingface">Hugging Face</option>
                                <option value="replicate">Replicate</option>
                                <option value="together">Together</option>
                                <option value="fireworks">Fireworks</option>
                                <option value="perplexity">Perplexity</option>
                                <option value="microsoft">Microsoft</option>
                            </select>
                        </div>
                        

                        
                        <div class="sm:col-span-2">
                            <label for="api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">API Key</label>
                            <input type="text" id="api_key" name="api_key" required 
                                   class="mt-1 block w-full border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   placeholder="Enter your API key"
                                   autocomplete="off"
                                   spellcheck="false">
                        </div>
                        

                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                            Add API Key
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Keys list -->
        <div id="api-keys-list" hx-get="/api-keys/list" hx-trigger="load" hx-swap="outerHTML">
            <div class="text-center text-gray-400 dark:text-gray-500">Loading API keys...</div>
        </div>
    </div>
</div>



<script>
    // Handle form submission with confirmation for updates
    document.addEventListener('DOMContentLoaded', function() {
        // Use specific ID selector instead of generic form selector
        const form = document.getElementById('api-key-form');
        const submitBtn = document.getElementById('submit-btn');
        const providerSelect = document.getElementById('provider');
        
        // Debug logging to verify form selection
        console.log('Form found:', form);
        console.log('Form ID:', form?.id);
        console.log('Form action:', form?.getAttribute('hx-post'));
        
        // Add global HTMX event listeners for debugging
        document.addEventListener('htmx:beforeRequest', function(event) {
            console.log('Global HTMX beforeRequest fired');
            console.log('Event target:', event.target);
            console.log('Event detail:', event.detail);
        });
        
        document.addEventListener('htmx:afterRequest', function(event) {
            console.log('Global HTMX afterRequest fired');
            console.log('Event target:', event.target);
            console.log('Event detail:', event.detail);
        });
        
        document.addEventListener('htmx:responseError', function(event) {
            console.log('Global HTMX responseError fired');
            console.log('Event target:', event.target);
            console.log('Event detail:', event.detail);
        });
        
        // Check if provider already has an API key
        function checkExistingKey() {
            const selectedProvider = providerSelect.value;
            if (!selectedProvider) return;
            
            // Look for existing API key in the current list
            const existingKeys = document.querySelectorAll('#api-keys-list tbody tr');
            let hasExistingKey = false;
            let existingKeyId = null;
            
            existingKeys.forEach(row => {
                const providerCell = row.querySelector('td:first-child');
                if (providerCell && providerCell.textContent.trim().toLowerCase() === selectedProvider.toLowerCase()) {
                    hasExistingKey = true;
                    // Get the row's data-id attribute for the update endpoint
                    existingKeyId = row.getAttribute('data-id');
                }
            });
            
            if (hasExistingKey) {
                submitBtn.textContent = 'Update API Key';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                
                // Set form to PUT method for updates
                form.setAttribute('hx-put', `/api-keys/${existingKeyId}/update`);
                form.removeAttribute('hx-post');
            } else {
                submitBtn.textContent = 'Add API Key';
                submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
                // Set form to POST method for creation
                form.setAttribute('hx-post', '/api-keys/add');
                form.removeAttribute('hx-put');
            }
        }
        
        // Update button text when provider changes
        providerSelect.addEventListener('change', function() {
            console.log('Provider changed to:', providerSelect.value);
            checkExistingKey();
            // Clear the API key field when provider changes
            document.getElementById('api_key').value = '';
        });
        
        // Check on page load - but wait for API keys to load first
        // We'll check after the initial HTMX load completes
        
        // Add form submit event listener for debugging
        form.addEventListener('submit', function(event) {
            console.log('Form submit event fired');
            console.log('Event:', event);
            console.log('Form data:', new FormData(form));
        });
        
        // Handle button click with confirmation - intercept before HTMX processes it
        submitBtn.addEventListener('click', function(event) {
            const selectedProvider = providerSelect.value;
            const apiKeyValue = document.getElementById('api_key').value;
            
            // Don't interfere if button is already disabled
            if (submitBtn.disabled) {
                console.log('Button already disabled, ignoring click');
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
            
            // Basic validation
            if (!selectedProvider || !apiKeyValue) {
                console.log('Missing required fields');
                return; // Let the browser handle validation
            }
            
            const existingKeys = document.querySelectorAll('#api-keys-list tbody tr');
            let hasExistingKey = false;
            
            console.log('Checking for existing key for provider:', selectedProvider);
            console.log('Found existing keys:', existingKeys.length);
            
            existingKeys.forEach(row => {
                const providerCell = row.querySelector('td:first-child');
                if (providerCell && providerCell.textContent.trim().toLowerCase() === selectedProvider.toLowerCase()) {
                    hasExistingKey = true;
                    console.log('Found existing key for provider:', selectedProvider);
                }
            });
            
            if (hasExistingKey) {
                console.log('Showing confirmation dialog');
                const confirmed = confirm(`An API key for ${selectedProvider} already exists.\n\nCurrent value will be replaced with the new one.\n\nAre you sure you want to update it?`);
                console.log('User confirmed:', confirmed);
                if (!confirmed) {
                    console.log('User cancelled, preventing form submission');
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
                
                console.log('User confirmed update, proceeding with form submission');
            }
            
            console.log('Proceeding with form submission');
            // Don't prevent default - let HTMX handle the submission
        });
        
        // Handle HTMX request start - attach to the specific form
        if (form) {
            form.addEventListener('htmx:beforeRequest', function(event) {
                console.log('HTMX beforeRequest fired - showing loading state');
                console.log('Event target:', event.target);
                console.log('Event detail:', event.detail);
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            });

            // Handle HTMX request completion - attach to the specific form
            form.addEventListener('htmx:afterRequest', function(event) {
                console.log('HTMX afterRequest fired - resetting button state');
                console.log('Event target:', event.target);
                console.log('Event details:', event.detail);
                console.log('Response status:', event.detail.xhr?.status);
                console.log('Response successful:', event.detail.successful);
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                if (event.detail.successful) {
                    form.reset();
                    
                    // Reset button state
                    submitBtn.textContent = 'Add API Key';
                    submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    
                    // Clear the API key input field specifically
                    const apiKeyField = document.getElementById('api_key');
                    apiKeyField.value = '';

                    // Show success message
                    showMessage('API key saved successfully!', 'success');
                } else {
                    // Reset button state on error
                    const selectedProvider = providerSelect.value;
                    const existingKeys = document.querySelectorAll('#api-keys-list tbody tr');
                    let hasExistingKey = false;
                    
                    existingKeys.forEach(row => {
                        const providerCell = row.querySelector('td:first-child');
                        if (providerCell && providerCell.textContent.trim().toLowerCase() === selectedProvider.toLowerCase()) {
                            hasExistingKey = true;
                        }
                    });
                    
                    if (hasExistingKey) {
                        submitBtn.textContent = 'Update API Key';
                        submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                    } else {
                        submitBtn.textContent = 'Add API Key';
                        submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                        submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                    
                    showMessage('Error saving API key. Please try again.', 'error');
                }
            });
            
        // Listen for when the API keys list loads to check for existing keys
        document.addEventListener('htmx:load', function(event) {
            if (event.target && event.target.id === 'api-keys-list') {
                setTimeout(() => {
                    checkExistingKey();
                }, 100);
            }
        });
        } else {
            console.error('API key form not found!');
        }
        
        // Function to show messages
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            messageDiv.textContent = message;
            
            // Add to page
            document.body.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    });
    
    // Close modal when clicking outside (keeping for any future modals)
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('edit-modal');
        if (modal && event.target === modal) {
            modal.classList.add('hidden');
        }
    });
    
    // Close modal with Escape key (keeping for any future modals)
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('edit-modal');
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
            }
        }
    });
    
    // Close modal when clicking close button (keeping for any future modals)
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('close-modal')) {
            const modal = document.getElementById('edit-modal');
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
            }
        }
    });
</script>
{% endblock %}
